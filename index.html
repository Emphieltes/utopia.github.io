<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utopia Planner v1.3.3 (JAN 24/26)</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background:#0d0d0d;
        color:#e0e0e0;
        margin:0;
        padding:20px 20px 40px 180px;
        min-height:100vh;
		box-sizing: border-box;
    }
    h1 {color:#4fc3f7; margin:0 0 5px 0; font-size:28px;}
    .subtitle {color:#888; font-size:0.9em; margin-bottom:50px;}
    .row {display:flex; align-items:center; margin:16px 0; gap:20px;}
    label {width:90px; text-align:right; font-weight:bold; font-size:14px; flex-shrink:0; color:#ccc;}
    .row label:nth-child(3) {width:100px; margin-left:20px;}
    select, input[type=number] {
        width:175px;
        padding:6px 10px;
        background:#222;
        color:#fff;
        border:1px solid #444;
        border-radius:4px;
        font-size:14px;
        box-sizing:border-box;
    }
    .bonuses-container {
        display: flex;
        gap: 40px;
        margin: 28px 0 10px 0;
        font-size: 14px;
        line-height: 1.7;
    }
    .bonus-column {
        flex: 1;
        max-width: 380px;
    }
    #persBonusBox {
        max-width: 380px;
    }
    .bonus-header {
        color: #ccc;
        font-weight: bold;
        font-size: 14px;
        text-decoration: underline;
        margin: 0 0 4px 0;
        padding-bottom: 2px;
    }
    .bonus {color:#4ade80;}
    .penalty {color:#ff6b6b;}

    /* UNIQUE ABILITIES ‚Äî CLEAN STYLE */
    .unique-line {
        margin: 18px 0 16px 0;
        font-size: 14.5px;
        color: #e0e0e0;
        white-space: normal;
		word-wrap: break-word;
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: #555 #111;
    }
    .unique-line strong {
        color: #4fc3f7;
        font-weight: bold;
    }
    .unique-line::-webkit-scrollbar {
        height: 6px;
    }
    .unique-line::-webkit-scrollbar-track {
        background: transparent;
    }
    .unique-line::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 3px;
    }
	#persUniqueLine {
		position: relative;
		padding-left: 190px;           /* space for the title */
		min-height: 24px;              /* prevents collapse */
		line-height: 1.55;
	}

	#persUniqueLine::before {
		content: "Personality Unique Ability:";
		position: absolute;
		left: 0;
		top: 0;
		width: 180px;
		text-align: right;
		color: #4fc3f7;                 /* ‚Üê back to your original blue! */
		font-weight: bold;
		white-space: nowrap;           /* ‚Üê THIS prevents it from ever wrapping */
		padding-right: 10px;
	}

	#persUniqueText {
		display: block;
		word-wrap: break-word;
	}

    .result {color:#4ade80; font-weight:bold; font-size:1.2em; min-width:120px; padding-left:10px;}
    hr {border:0; border-top:1px solid #333; margin:50px 0;}
    button {width:400px; padding:15px; background:#4fc3f7; color:#000; font-weight:bold; font-size:18px; border:none; border-radius:6px; cursor:pointer; margin:40px 0 10px 0;}
    button:hover {background:#81d4fa;}
    .bigbtn {background:#ff4444;}
    .bigbtn:hover {background:#ff6666;}
	
/* LIGHT MODE OVERRIDES */
body.light-mode {
    background: #f5f5f5;
    color: #1a1a1a !important;   /* main text color */
}

/* Specific overrides for static elements */
body.light-mode h1 { color: #1976d2 !important; }
body.light-mode .bonus { color: #2e7d32 !important; font-weight: bold !important; }
body.light-mode .penalty { color: #c62828 !important; font-weight: bold !important; }
body.light-mode .unique-line strong { color: #1565c0 !important; }
body.light-mode .unique-line span { color: #1a1a1a !important; }
body.light-mode #persUniqueLine::before { color: #1565c0 !important; }
body.light-mode div[style*="color:#4fc3f7"] { color: #1565c0 !important; }
body.light-mode .subtitle { color: #444 !important; }
body.light-mode .bonus-header { color: #444 !important; }
body.light-mode label { color: #444 !important; }

/* Restore dynamic inline colors (JS-set) - yellow, green, red */
body.light-mode td[style*="color:#FFFF61"],
body.light-mode span[id$="Cost"],
body.light-mode span[id^="calc"] {
    color: inherit !important;  /* Let JS inline style win */
}

/* Inputs & table backgrounds (keep these) */
body.light-mode select,
body.light-mode input[type="number"],
body.light-mode input[type="text"],
body.light-mode #militaryTable input,
body.light-mode #TrainingTable input {
    background: #ffffff !important;
    color: #000000 !important;
    border: 1px solid #999 !important;
}

body.light-mode table { background: #fff !important; }
body.light-mode thead tr { background: #e8e8e8 !important; }
body.light-mode tbody tr { background: #fafafa !important; }
body.light-mode tbody tr:hover { background: #f0f0f0 !important; }

/* Buttons */
body.light-mode button { background: #1976d2 !important; color: #ffffff !important; }
body.light-mode button:hover { background: #1565c0 !important; }
body.light-mode .bigbtn { background: #d32f2f !important; }
body.light-mode .bigbtn:hover { background: #b71c1c !important; }

/* Darken table text, but DO NOT override JS-colored cells */
body.light-mode #militaryTable td,
body.light-mode .bonus-container td,
body.light-mode .bonus-container span {
    color: #1a1a1a !important;
}

/* Allow dynamic JS coloring inside Training table */
body.light-mode #TrainingTable td {
    color: #1a1a1a; /* default text */
}

body.light-mode #TrainingTable td span {
    color: inherit; /* allow inline JS color */
}

/* Restore yellow/gold cost in both tables */
body.light-mode td[style*="color:#FFFF61"],
body.light-mode span[id$="Cost"] {
    color: #d4af37 !important;  /* Muted gold - visible on light bg */
}

/* Darken all table header text in light mode */
body.light-mode thead td,
body.light-mode thead th {
    color: #1a1a1a !important;  /* Dark black for readability */
}

/* Optional: Make header background slightly darker for contrast */
body.light-mode thead tr {
    background: #e0e0e0 !important;  /* Light grey bg to make headers stand out */
}

/* Darken the inline light grey headers in Target Ratios table for light mode */
body.light-mode td[style*="color:#ccc"][style*="font-weight:bold"] {
    color: #1a1a1a !important;  /* Dark black for readability */
}

/* Allow inline yellow cost in military table */
body.light-mode #militaryTable td[style*="color:#FFFF61"] {
    color: #d4af37 !important;  /* Muted gold/yellow */
}

/* Explicitly let JS inline green/red win on To be Trained spans */
body.light-mode #calcOff,
body.light-mode #calcDef,
body.light-mode #calcThieves {
    color: inherit !important;
}

/* Transitions */
body, body * {
    transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
}

/* Override inline light grey (#ccc) on Training Table unit names/labels in light mode */
body.light-mode #TrainingTable tbody td[style*="color:#ccc"] {
    color: #1a1a1a !important;  /* Force dark text, overrides inline */
    font-weight: bold !important;
}

/* Optional: Make Soldiers Needed row even more prominent in light mode */
body.light-mode #TrainingTable tbody tr:last-child td {
    background: #f0f0f0 !important;  /* Subtle highlight */
    font-weight: bold !important;
    font-size: 15px;  /* Slightly larger */
}

/* Make Army & Draft Stats titles match Military table unit style in BOTH modes */
#armyDraftTable td:first-child,
#armyDraftTable th:first-child {
    font-weight: normal !important;          /* Remove bold */
    font-size: 14.5px !important;            /* Match Military table font size */
    color: #ccc !important;                  /* Light grey in dark mode */
    padding: 3px 14px !important;            /* Consistent padding */
}

/* Force dark text in light mode (overrides any inline or inherited styles) */
body.light-mode #armyDraftTable td:first-child,
body.light-mode #armyDraftTable th:first-child {
    color: #1a1a1a !important;               /* Dark black for light mode */
    font-weight: normal !important;
}

</style>
</head>
<!-- LEFT FIXED BUTTONS -->
<div style="position:fixed; left:0; top:16px; z-index:9999; display:flex; flex-direction:column; gap:3px; padding:10px;">
   
   <!-- BUTTON 1 - PLANNER -->
	<button onclick="goToPage('Planner v1.3.1.html')" style="
        width:140px;
        padding:6px 16px;
        background: #595959;           /* ‚Üê CHANGE COLOR HERE (blue example) */
        color:#ffffff;                /* ‚Üê TEXT COLOR */
        text-align:left;
		font-size:16px;               /* ‚Üê FONT SIZE */
        font-weight:bold;
        font-family:Arial, sans-serif;
        border:2px solid #FFD700;
        border-radius:1;              /* ‚Üê 0 = sharp corners, 8px = rounded, etc. */
        cursor:pointer;
        box-shadow:4px 0 12px rgba(0,0,0,0.6);
		margin: 0;
        transition:background 0.2s;">
        Planner
    </button>
	
	<!-- BUTTON 2 - SCIENCES -->
    <button onclick="goToPage('Sciences v1.0.4.html')" style="
        width:140px;
        padding:6px 16px;
        background:#595959;           /* ‚Üê different color for button 2 */
        color:#ffffff;
        text-align:left;
		font-size:16px;
        font-weight:bold;
        border:2px solid #FFD700;
        border-radius:1;
        cursor:pointer;
        box-shadow:4px 0 12px rgba(0,0,0,0.6);
		margin: 0;
        transition:background 0.2s;">
        Sciences
    </button>
	
	<!-- BUTTON 3 - PARSER -->
    <button onclick="goToPage('Parser v1.4.3.html')" style="
        width:140px;
        padding:6px 16px;
        background:#595959;           /* ‚Üê different color for button 3 */
        color:#ffffff;
        text-align:left;
		font-size:16px;
        font-weight:bold;
        border:2px solid #FFD700;
        border-radius:1;
        cursor:pointer;
        box-shadow:4px 0 12px rgba(0,0,0,0.6);
		margin: 0;
        transition:background 0.2s;">
        Parser
    </button>
</div>

<!-- BUTTON 4 - LIGHT/DARK MODE TOGGLE -->
<div style="position: fixed; left: 0; bottom: 16px; z-index: 9999; padding: 10px;">
	<button id="themeToggle" style="
		width:140px;
		padding:6px 16px;
		background:#4fc3f7;
		color:#000;
		text-align:left;
		font-size:14px;
		font-weight:bold;
		border:2px solid #FFD700;
		border-radius:1;
		cursor:pointer;
		box-shadow:4px 0 12px rgba(0,0,0,0.6);
		margin: 100;
		transition:background 0.2s;">
		üåô Dark Mode
	</button>	
</div>

<!-- VERTICAL SEPARATOR LINE -->
<div style="position:fixed; left:160px; top:0; bottom:0; width:2px; background:#444; z-index:9998; box-shadow:0 0 8px rgba(0,0,0,0.6);">
</div>

<body>
<!-- PLANNER HEADER/TITLE -->
<h1>UTOPIA PROVINCE PLANNER - AGE 114</h1>

<div class="subtitle">Train perfectly. Every time.</div>

<div class="row" style="margin-left:-50px; margin-top:-20px; margin-bottom:16px;">
    <label>Race</label>
	<!-- RACE SELECTION -->
    <select id="race" style="width:175px;">
        <option>Avian</option>
        <option>Dark Elf</option>
        <option>Dwarf</option>
        <option>Elf</option>
        <option>Faery</option>
        <option>Halfling</option>
        <option>Human</option>
        <option>Orc</option>
        <option>Undead</option>
        <!--<option>Gnome</option> -->
    </select>
    <label>Personality</label>
    <!-- PERSONALITY SELECTION -->
	<select id="pers" style="width:175px;">
        <option>Artisan</option>
        <!--<option>Cleric</option>-->
        <option>Heretic</option>
        <option>Mystic</option>
        <option>Rogue</option>
        <option>Tactician</option>
        <option>Warrior</option>
        <option>Paladin</option>
        <option>Necromancer</option>
        <option>General</option>
		<option>War Hero</option>
    </select>
</div>

<div class="row" style="margin-left:-50px; margin-top:-12px; margin-bottom:16px;">
    <label>Acres</label>
    <input type="number" id="acres" style="width:175px;" value="400">
    <label>Honor Title</label>
    <!-- HONOR SELECTION -->
	<select id="title" style="width:175px;">
        <option>Peasant</option>
        <option>Knight/Lady</option>
        <option>Lord/Noble Lady</option>
        <option>Baron/Baroness</option>
        <option>Viscount/Viscountess</option>
        <option>Count/Countess</option>
        <option>Marquis/Marchioness</option>
        <option>Duke/Duchess</option>
        <option>Prince/Princess</option>
    </select>
</div>

<!-- SIDE-BY-SIDE RACE & PERSONALITY BONUSES -->
<div class="bonuses-container">
    <div class="bonus-column" id="raceBonusBox"></div>
    <div class="bonus-column" id="persBonusBox"></div>
</div>

<!-- WAR DOCTRINE -->
<div class="unique-line" id="warDoctrineLine" style="display: none;">
    <strong style="color: #690202;">War Doctrine:</strong> 
    <span id="warDoctrineText">Select a race to see its war doctrine</span>
</div>

<!-- RACE UNIQUE ABILITY -->
<div class="unique-line" id="raceUniqueLine">
    <strong>Race Unique Ability:</strong> <span id="uniqueText">Select a race to see its unique ability</span>
</div>

<!-- PERSONALITY UNIQUE ABILITY -->
<div class="unique-line" id="persUniqueLine">
    <span id="persUniqueText">Select a personality to see its unique ability</span>
</div>

<!-- MAIN LAYOUT: TWO TABLES SIDE BY SIDE -->
<div style="margin-left:0px; margin-top:24px; display:flex; gap:50px; align-items:flex-start; position:relative;">

    <!-- MILITARY TRAINING HEADER -->
    <div style="flex-shrink:0;">
        <div style="font-size:16px; color:#4fc3f7; font-weight:bold; padding-bottom:8px;">
            MILITARY TRAINING
        </div>
        <!-- OME/DME TABLE -->
        <div style="margin-left:-75px; margin-bottom:12px; display:flex; flex-direction:column; gap:11px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <label style="width:110px; text-align:right; color:#ccc; font-weight:bold;">OME</label>
                <input type="number" id="ome" value="100" min="0" step="0.1"
                       style="width:110px; padding:6px 8px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
                <span style="color:#888;">%</span>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <label style="width:110px; text-align:right; color:#ccc; font-weight:bold;">DME</label>
                <input type="number" id="dme" value="100" min="0" step="0.1"
                       style="width:110px; padding:6px 8px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
                <span style="color:#888;">%</span>
            </div>
        </div>
        <!-- MILITARY TABLE -->
        <table style="width:450px; table-layout:fixed; border-collapse:separate; border-spacing:0 8px; font-size:14.5px; background:#111; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.6);">
            <thead>
                <tr style="height:25px; background:#222;">
                    <td style="width:10px; padding-left:14px; color:#ccc; text-align:left; font-weight:bold;">Units</td>
                    <td style="width:15px; color:#ccc; text-align:center; font-weight:bold;">Owned</td>
                    <td style="width:10px; color:#ccc; text-align:center; font-weight:bold;">Training</td>
                    <td style="width:0px; color:#ccc; text-align:right; padding-right:14px; font-weight:bold;">Cost</td>
                </tr>
            </thead>
            <tbody id="militaryTable" style="background:#0f0f0f;"></tbody>
        </table>
		<!-- TRAINING TABLE -->
		<div style="position:absolute; left:0px; top:310px; width:300px;">
        <table style="width:400px; table-layout:fixed; border-collapse:separate; border-spacing:0 8px; font-size:14.5px; background:#111; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.6);">
            <thead>
                <tr style="height:25px; background:#222;">
                    <td style="width:2px; padding-left:14px; color:#ccc; text-align:left; font-weight:bold;">Units</td>
                    <td style="width:10px; color:#ccc; text-align:center; font-weight:bold;">To be Trained</td>
                    <td style="width:18px; color:#ccc; text-align:center; font-weight:bold;">Cost</td>                    
                </tr>
            </thead>
            <tbody id="TrainingTable" style="background:#0f0f0f;"></tbody>
        </table>
    </div>

    <!-- TARGET RATIOS TABLE -->
    <div style="position:absolute; left:475px; top:108px; width:300px;">
        <table style="width:300px; table-layout:fixed; border-collapse:separate; border-spacing:0 8px; font-size:14.5px; background:#111; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.6);">
            <thead>
                <tr style="height:25px; background:#222;">
                    <td style="width:10px; padding-left:8px; color:#ccc;"></td>
                    <td style="width:20px; color:#ccc; text-align:center;">Raw Target</td>
                    <td style="width:30px; color:#ccc; text-align:center; font-weight:bold;">Modified Target</td>
                </tr>
            </thead>
            <tbody style="background:#0f0f0f;">
                <tr>
                    <td style="padding:8px 14px; color:#ccc; font-weight:bold;">OSPA</td>
                    <td style="text-align:center;">
                        <input type="number" id="targetOSPA" step="0.1" value="8.5" style="width:90px; height:23px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
                    </td>
                    <td style="text-align:center; font-weight:bold;" id="resultOSPA">-</td>
                </tr>
                <tr>
                    <td style="padding:7px 14px; color:#ccc; font-weight:bold;">DSPA</td>
                    <td style="text-align:center;">
                        <input type="number" id="targetDSPA" step="0.1" value="7.0" style="width:90px; height:23px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
                    </td>
                    <td style="text-align:center; font-weight:bold;" id="resultDSPA">-</td>
                </tr>
                <tr>
                    <td style="padding:7px 14px; color:#ccc; font-weight:bold;">Elites</td>
                    <td style="text-align:center;">
                        <input type="number" id="targetElite" step="0.1" value="1.1" style="width:90px; height:23px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
                    </td>
                    <td style="text-align:center; font-weight:bold;" id="resultElite">-</td>
                </tr>
                <tr>
                    <td style="padding:7px 14px; color:#ccc; font-weight:bold;">TPA</td>
                    <td style="text-align:center;">
                        <input type="number" id="targetTPA" step="0.1" value="1.2" style="width:90px; height:23px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
                    </td>
                    <td style="text-align:center; font-weight:bold;" id="resultTPA">-</td>
                </tr>
            </tbody>
        </table>
    </div>
	<!-- DRAFT TARGET TABLE -->
	<div style="position:absolute; left:475px; top:310px; width:300px;">
		<table id="armyDraftTable" style="width:300px; table-layout:fixed; border-collapse:separate; border-spacing:0 8px; font-size:14.5px; background:#111; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.6);">
			<tbody style="background:#0f0f0f;">
				<tr>
					<td style="padding:8px 14px; color:#ccc; font-weight:bold;">Total Army</td>
					<td style="text-align:center; font-weight:bold; color:#4ade80;" id="totalArmy">0</td>
				</tr>
				<tr>
					<td style="padding:7px 14px; color:#ccc; font-weight:bold;">Total Population</td>
					<td style="text-align:center; font-weight:bold; color:#4ade80;" id="totalPopulation">0</td>
				</tr>
				<tr>
					<td style="padding:7px 14px; color:#ccc; font-weight:bold;">Homes (%)</td>
					<td style="text-align:center;">
						<input type="number" id="homesPercent" step="0.0001" value="0" style="width:90px; height:23px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
					</td>
				</tr>
				<tr>
					<td style="padding:7px 14px; color:#ccc; font-weight:bold;">Housing Science</td>
					<td style="text-align:center; font-weight:bold; color:#4ade80;" id="displayHousingScience">
						‚Äî%
					</td>
				</tr>
				<tr>
					<td style="padding:7px 14px; color:#ccc; font-weight:bold;">Target Draft</td>
					<td style="text-align:center;">
						<input type="number" id="targetDraft" step="0.0001" value="0" style="width:90px; height:23px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- DRAFT TIMELINE TABLE -->
	<div style="position:absolute; left:820px; top:310px; width:300px;">
		<table style="width:350px; table-layout:fixed; border-collapse:separate; border-spacing:0 8px; font-size:14.5px; background:#111; border-radius:8px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.6);">
			<tbody style="background:#0f0f0f;">
				<td style="text-align:center; padding:3px 0;">
					<div style="display:flex; gap:8px; justify-content:center; align-items:center; width:260px; margin:0 auto;">
						<select id="utopiaYear" style="width:70px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; padding:4px; text-align:center;">
							<option>YR1</option>
							<option>YR2</option>
							<option>YR3</option>
							<option>YR4</option>
							<option>YR5</option>
							<option>YR6</option>
							<option>YR7</option>
							<option>YR8</option>
							<option>YR9</option>
							<option>YR10</option>
							<option>YR11</option>
						</select>
						<select id="utopiaMonth" style="width:100px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; padding:4px; text-align:center;">
							<option value="1">January</option>
							<option value="2">February</option>
							<option value="3">March</option>
							<option value="4">April</option>
							<option value="5">May</option>
							<option value="6">June</option>
							<option value="7">July</option>
						</select>
						<select id="utopiaDay" style="width:60px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; padding:4px; text-align:center;">
							<!-- populated by JS -->
						</select>
					</div>
				</td>
				<tr>
					<td style="padding:3px 14px;">Training Period (Days)</td>
					<td style="text-align:center;">
						<input type="number" id="trainingPeriod" value="19" min="0" style="width:90px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
					</td>
				</tr>
				<tr>
					<td style="padding:3px 14px;">Draft Period (Days)</td>
					<td style="text-align:center;">
						<input type="number" id="draftPeriod" value="50" min="0" style="width:90px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
					</td>
				</tr>
				<tr>
					<td style="padding:3px 14px;">Draft by Date</td>
					<td style="text-align:center; font-weight:bold; color:#ff9f43;" id="draftByDate">-</td>
				</tr>
				<tr>
					<td style="padding:3px 14px;">Train by Date</td>
					<td style="text-align:center; font-weight:bold; color:#ff9f43;" id="trainByDate">-</td>
				</tr>
			</tbody>
		</table>
	</div>

</div>

<script>
window.onload = () => {
    const saved = localStorage.getItem('utopiaPlanner');
    if (saved) {
        const data = JSON.parse(saved);

        // Restore top dropdowns, OME/DME, and targets FIRST (these are static)
        document.getElementById('race').value      = data.race      || 'Avian';
        document.getElementById('pers').value      = data.pers      || 'Artisan';
        document.getElementById('title').value     = data.title     || 'Peasant';
        document.getElementById('acres').value     = data.acres     || '400';
        document.getElementById('ome').value       = data.ome       || '100';
        document.getElementById('dme').value       = data.dme       || '100';
        document.getElementById('targetOSPA').value = data.targetOSPA || '8.5';
        document.getElementById('targetDSPA').value = data.targetDSPA || '7.0';
        document.getElementById('targetElite').value = data.targetElite || '1.1';
        document.getElementById('targetTPA').value  = data.targetTPA  || '1.2';
    }

    // Build the tables (this creates the dynamic inputs)
    updateBonuses();
    updateMilitaryTable();
    updateTrainingTable();
    updateTargetRatios();
	
	// NOW restore Homes % (now the element exists)
    if (saved) {
        const data = JSON.parse(saved);
        document.getElementById('homesPercent').value = data.homesPercent || '0';   // ‚Üê MOVE IT HERE
    }

    // NOW restore Training values (inputs now exist)
    if (saved) {
		const data = JSON.parse(saved);
		['trainOff', 'trainDef', 'trainElite', 'trainThief', 'curOff', 'curDef', 'curElite', 'curThief'].forEach(id => {
			const input = document.getElementById(id);
			if (input && data[id] !== undefined) {
				input.value = data[id];
			}
		});
		// NEW: Restore Utopia calendar & periods
		const utopiaFields = ['utopiaYear', 'utopiaMonth', 'utopiaDay', 'draftPeriod', 'trainingPeriod'];
		utopiaFields.forEach(id => {
			const el = document.getElementById(id);
			if (el && data[id] !== undefined) {
				el.value = data[id];
			}
		});

		// After restoring values, recalculate dates
		calculateDates();
	}

    // Final calculations
    updateTargetRatios();
	calculateThievesNeeded();
    calculateDefNeeded();
    calculateOffNeeded();
	calculateEliteNeeded();
	calculateTotalTraining();
	calculateTotalPopulation();
};

document.querySelectorAll('#race, #pers, #title, #acres, #ome, #dme, #targetOSPA, #targetDSPA, #targetElite, #targetTPA, #homesPercent').forEach(el => {
    el.addEventListener('change', () => {
        // 1. SAVE CURRENT Owned + Training values BEFORE table is destroyed
        const savedMilitary = {
            curOff:     document.querySelector('#curOff')?.value     || "0",
            curDef:     document.querySelector('#curDef')?.value     || "0",
            curElite:   document.querySelector('#curElite')?.value   || "0",
            curThief:   document.querySelector('#curThief')?.value   || "0",
            trainOff:   document.querySelector('#trainOff')?.value   || "0",
            trainDef:   document.querySelector('#trainDef')?.value   || "0",
            trainElite: document.querySelector('#trainElite')?.value || "0",
            trainThief: document.querySelector('#trainThief')?.value || "0"
        };

        // 2. Save all main settings including targets
        const data = {
            race:       document.getElementById('race').value,
            pers:       document.getElementById('pers').value,
            title:      document.getElementById('title').value,
            acres:      document.getElementById('acres').value,
            ome:        document.getElementById('ome').value || "100",
            dme:        document.getElementById('dme').value || "100",
            targetOSPA: document.getElementById('targetOSPA').value || "8.5",
            targetDSPA: document.getElementById('targetDSPA').value || "7.0",
            targetElite:document.getElementById('targetElite').value || "1.1",
            targetTPA:  document.getElementById('targetTPA').value  || "1.2",
			utopiaYear:   document.getElementById('utopiaYear')?.value   || "YR1",
			utopiaMonth:  document.getElementById('utopiaMonth')?.value  || "1",
			utopiaDay:    document.getElementById('utopiaDay')?.value    || "1",
			draftPeriod:  document.getElementById('draftPeriod')?.value  || "50",
			trainingPeriod: document.getElementById('trainingPeriod')?.value || "19",
			homesPercent: document.getElementById('homesPercent')?.value || "0"
        };
        localStorage.setItem('utopiaPlanner', JSON.stringify({...data, ...savedMilitary}));

        updateBonuses();
        updateMilitaryTable();
        updateTrainingTable();
        updateTargetRatios();
    });
});

// NEW: Make changes to Draft Calculator fields trigger a full save
['utopiaYear', 'utopiaMonth', 'utopiaDay', 'draftPeriod', 'trainingPeriod'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('change', () => {
            // Trigger the same save logic as above by simulating a change on one of the monitored fields
            document.getElementById('race')?.dispatchEvent(new Event('change'));
        });
    }
});

function updateBonuses() {
    const race = document.getElementById('race').value;
    const pers = document.getElementById('pers').value;

    // === RACE Bonuses/Penalities ===
    let raceHtml = '';
    let raceUnique = "Select a race to see its unique ability";
	let warDoctrine = "Select a race to see its war doctrine";

	// === AVIAN ===
    if (race === "Avian") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ -20% Attack Time</span><br>
            <span class="bonus">‚Ä¢ -40% Training Time</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ Cannot Ambush</span><br>
            <span class="penalty">‚Ä¢ No Access to Stables/War Horses</span>
        `;
        raceUnique = "(Passive) - Learn and Plunder attacks return armies 1 tick faster (after modifiers)";
		warDoctrine = "(In War): Provides up to ‚àí5% Attack Time to you and all your kingdom.";
    }
	// === DARK ELF ===
    else if (race === "Dark Elf") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ +25% Instant Spell Damage</span><br>
            <span class="bonus">‚Ä¢ -50% Rune Cost (Not Including Ritual)</span><br>
            <span class="bonus">‚Ä¢ Can Train Thieves with Specialist Credits</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ -25% Birth Rates</span>
        `;
        raceUnique = "(Passive) - Successful offensive instant spells refund 20% rune cost.";
		warDoctrine = "(In War): Provides up to +7.5% Instant Spell Damage to you and all your kingdom.";
    }
	// === DWARF ===
    else if (race === "Dwarf") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ +25% Building Efficiency</span><br>
            <span class="bonus">‚Ä¢ -50% Construction Time</span><br>
            <span class="bonus">‚Ä¢ +20% Building Credits in Combat</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ Cannot Accelerate Construction</span><br>
            <span class="penalty">‚Ä¢ +10% Attack Time Costs</span>
        `;
        raceUnique = "(Passive) - Incoming Raze damage reduced by 15% and Raze attacks destroy 20% additional buildings.";
		warDoctrine = "(In War): Provides up to +7.5% Specialist Credits gained in combat to you and all your kingdom.";
    }
	// === ELF ===
    else if (race === "Elf") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ +30% Magic Effectiveness (WPA)</span><br>
            <span class="bonus">‚Ä¢ +1 Mana per Tick</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ -20% TPA</span>
        `;
        raceUnique = "(Passive) - Whenever your province‚Äôs mana drops below 40%, all spells you cast while under that threshold deal +25% spell damage. Boost disappears once mana climbs above 35%.";
		warDoctrine = "(In War): Provides up to ‚àí7.5% Military Casualties Taken to you and all your kingdom.";
    }
	// === FAERY ===
    else if (race === "Faery") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ +25% Magic Effectiveness (WPA)</span><br>
            <span class="bonus">‚Ä¢ +25% Spell Duration</span><br>
            <span class="bonus">‚Ä¢ +1 Mana per Tick</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ +15% Military Wages</span><br>
            <span class="penalty">‚Ä¢ -10% Building Efficiency</span>
        `;
        raceUnique = "(Passive) - Enemy spells cast against Faery provinces have a 15% chance to fail.";
		warDoctrine = "(In War): Provides up to ‚àí7.5% damage from enemy Thievery and Magic instant operations to you and all your kingdom.";
    }
	// === HALFLING ===
    else if (race === "Halfling") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ +10% Max Population</span><br>
            <span class="bonus">‚Ä¢ +1 Stealth per Tick</span><br>
            <span class="bonus">‚Ä¢ +20% Thievery Effectiveness (TPA)</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ +15% Military Casaulties</span>
        `;
        raceUnique = "(Active) - All thievery operations incur zero thievery losses for 1 tick. 23 Hour Cooldown";
		warDoctrine = "(In War): Provides up to +7.5% Sabotage damage to you and all your kingdom.";
    }
	// === HUMAN ===
    else if (race === "Human") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ All lands hold prisoners - 2 per acre</span><br>
            <span class="bonus">‚Ä¢ +1 Stealth Recovery per Tick (In War)</span><br>
            <span class="bonus">‚Ä¢ +15% Science Efficiency</span><br><br>
            <div class="bonus-header">Race Penalties</div>
			<span class="penalty">‚Ä¢ Military wage increases take twice as long to fully apply. Wage reductions apply normally.</span><br>
			<span class="penalty">‚Ä¢ +50 Rune Cost (Does NOT Include Rituals</span><br>
            <span class="penalty">‚Ä¢ -50% Libraries BE</span>
        `;
        raceUnique = "(Passive) - Prisoners generate an additional 2gc per tick and Mercenary costs are reduced by 25%.";
		warDoctrine = "(In War): Provides up to +7.5% Book Generation to you and all your kingdom.";
    }
	// === ORC ===
    else if (race === "Orc") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ +15% Battle Gains</span><br>
            <span class="bonus">‚Ä¢ -50% Draft Costs</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ -15% Defensive Military Efficiency (DME)</span>
        `;
        raceUnique = "(Passive) - Successful Traditional Marches capture +30% additional Prisoners and Massacre attacks are +15% more effective at killing Wizards.";
		warDoctrine = "(In War): Provides up to +7.5% Enemy Military Casualties to you and all your kingdom.";
    }
	// === UNDEAD ===
    else if (race === "Undead") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ -40% Military Losses</span><br>
            <span class="bonus">‚Ä¢ Immune to Plague</span><br>
            <span class="bonus">‚Ä¢ No Food Needed</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ -5% Offensive Military Efficiency (OME)</span>
        `;
        raceUnique = "(Passive) - Plague has a chance to spread on all successful attacks (33% chance).";
		warDoctrine = "(In War): Provides up to ‚àí7.5% Enemy Battle Gains to you and all your kingdom.";
    }
	// === GNOME ===
    else if (race === "Gnome") {
        raceHtml = `
            <div class="bonus-header">Race Bonuses</div>
            <span class="bonus">‚Ä¢ -10% Attack Time (War Only)</span><br>
            <span class="bonus">‚Ä¢ +15% Enemy Military Casualties</span><br>
            <span class="bonus">‚Ä¢ +15% Thievery Effectiveness (TPA)</span><br><br>
            <div class="bonus-header">Race Penalties</div>
            <span class="penalty">‚Ä¢ +25% Rune Cost</span><br>
            <span class="penalty">‚Ä¢ -15% Wizards per Acre (WPA)</span>
        `;
        raceUnique = "(Passive) - Each successful attack has a chance to provide all the following thievery boosts for 6 days: +20% TPA; ‚Äì30% Thief Losses; +25% Sabotage Damage. These boosts can stack and display timers on your Throne.";
		warDoctrine = "(In War): Provides up to ‚àí5% Attack Time to you and all your kingdom.";
    }

    document.getElementById('raceBonusBox').innerHTML = raceHtml;
    document.getElementById('uniqueText').textContent = raceUnique;
	
	// WAR DOCTRINE DISPLAY
    const doctrineText = document.getElementById('warDoctrineText');
    const doctrineLine = document.getElementById('warDoctrineLine');

    if (doctrineText && doctrineLine) {
        doctrineText.textContent = warDoctrine || "No War Doctrine defined for this race.";
        doctrineLine.style.display = warDoctrine ? "block" : "none";
    }

    // === PERSONALITY Bonuses ===
    let persHtml = '';
    let persUnique = "";

	// === ARTISAN ===
    if (pers === "Artisan") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +30% Building Capacity (Homes, Stables, Dungeons)</span><br>
            <span class="bonus">‚Ä¢ +30% Building Production (Banks, Farms, Stables, Towers)</span><br>
            <span class="bonus">‚Ä¢ 100% Successful Espionage Ops (Double Stealth Cost)</span><br>
            <span class="bonus">‚Ä¢ +15% Economy Science Effectiveness</span>
        `;
        persUnique = "(Passive) - For 6 ticks, after a successful attack, enemy building efficiency is reduced by 10% (does not stack).";
    }
	// === CLERIC ===
    else if (pers === "Cleric") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +1 Elite Defensive Strength</span><br>
            <span class="bonus">‚Ä¢ +1 Defensive Specialist Strength</span><br>
            <span class="bonus">‚Ä¢ -1 Self-Spell Mana Cost</span><br>
            <span class="bonus">‚Ä¢ +35% Hospital Effectiveness</span><br>
            <span class="bonus">‚Ä¢ Immune to Plague</span>
        `;
        persUnique = "(Passive) - When casting self-spells, Clerics have a 50% chance to double their duration.";
    }
	// === HERETIC ===
    else if (pers === "Heretic") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ -40% Thief Cost</span><br>
            <span class="bonus">‚Ä¢ +25% TPA</span><br>
            <span class="bonus">‚Ä¢ +20% Sabotage Damage</span><br>
            <span class="bonus">‚Ä¢ +50% Guilds Effectiveness</span><br>
            <span class="bonus">‚Ä¢ +15% Arcane Arts Science Effectiveness</span>
        `;
        persUnique = "(Active) - For 2 ticks, all offensive spells and sabotage operations deal a random increased damage bonus between +10% and +30% (23hr Cooldown).";
    }
	// === MYSTIC ===
    else if (pers === "Mystic") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +125% Guild Effectiveness</span><br>
            <span class="bonus">‚Ä¢ +1 Mana Recovery per Tick</span><br>
            <span class="bonus">‚Ä¢ +15% Channeling Science Effectiveness</span>
        `;
        persUnique = "(Passive) - While above 40% mana, spells gain +20% WPA.";
    }
	// === ROGUE ===
    else if (pers === "Rogue") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +100% Thieves Den Effectiveness</span><br>
            <span class="bonus">‚Ä¢ +1 Stealth Recovery per Tick</span><br>
            <span class="bonus">‚Ä¢ +15% TPA</span><br>
            <span class="bonus">‚Ä¢ +15% Crime Science Effectiveness</span><br>
            <span class="bonus">‚Ä¢ Access to all Thievery Ops</span>
        `;
        persUnique = "(Passive) - Rogue provinces may perform thievery operations while overpopulated.";
    }
	// === TACTICIAN ===
    else if (pers === "Tactician") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ -15% Attack Time</span><br>
			<span class="bonus">‚Ä¢ +40% Specialist Credit Gains</span><br>
            <span class="bonus">‚Ä¢ No Thief Losses on Espionage Ops</span><br>
            <span class="bonus">‚Ä¢ +15% Siege Science Effectiveness</span><br>
			<span class="bonus">‚Ä¢ Access to Clearsight</span><br>
            <span class="bonus">‚Ä¢ Enhanced Conquest</span>
        `;
        persUnique = "(Passive) - When successfully attacking with a dragon, 3% of your raw offence from units will also deal damage to the dragon.";
    }
	// === WARRIOR ===
    else if (pers === "Warrior") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +10% Offensive Military Efficiency</span><br>
            <span class="bonus">‚Ä¢ +4 Mercenary & Prisoner Strength</span><br>
            <span class="bonus">‚Ä¢ -50% Mercenary Cost</span><br>
            <span class="bonus">‚Ä¢ +15% Tactics Science Effectiveness</span><br>
            <span class="bonus">‚Ä¢ Access to Bloodlust</span>
        `;
        persUnique = "(Passive) - Upon each successful attack, the attack destroys 0.5% of the targets total population.";
    }
	// === PALADIN ===
    else if (pers === "Paladin") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +5% Population</span><br>
            <span class="bonus">‚Ä¢ +50% Stable Capacity and Production</span><br>
			<span class="bonus">‚Ä¢ Successful attacks inflict +15% enemy military casualties but also suffer +10% offensive military casualties</span><br>
            <span class="bonus">‚Ä¢ Immune to Plague</span><br>
            <span class="bonus">‚Ä¢ +15% Valor Science Effectiveness</span>
			
        `;
        persUnique = "(Passive) - All daily bonuses (granted on the 1st of each month) are doubled.";
    }
	// === NECROMANCER ===
    else if (pers === "Necromancer") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +30% Wizards per Acre (WPA)</span><br>
            <span class="bonus">‚Ä¢ +25% of Military Losses to Soldiers</span><br>
            <span class="bonus">‚Ä¢ Reclaims 30% Enemy Losses as Soldiers on Successful attacks</span><br>
			<span class="bonus">‚Ä¢ Access to Animate Dead, Mystic Aura, Vermin, Pitfalls, Mind Focus</span><br>
            <span class="bonus">‚Ä¢ +15% Channeling Science Effectiveness</span>
        `;
        persUnique = "(Passive) - Successful offensive instant spells also inflict necrotic fallout on the target province: kills 1% of target peasants per successful instant spell.";
    }
	// === GENERAL ===
    else if (pers === "General") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ +1 General</span><br>
            <span class="bonus">‚Ä¢ +20% Specialist Credits gained in Combat</span><br>
            <span class="bonus">‚Ä¢ -25% Military Train Time</span><br>
            <span class="bonus">‚Ä¢ Can Train Elites with Specialist Credits (In War)</span><br>
			<span class="bonus">‚Ä¢ +15% Bookkeeping Science Efficiency</span><br>
			<span class="bonus">‚Ä¢ Access to Wrath</span>
        `;
        persUnique = "(Passive) - Attacks inflict +15% enemy military casualties when two or more generals are sent.";
    }
	// === WAR HERO ===
    else if (pers === "War Hero") {
        persHtml = `
            <div class="bonus-header">Personality Bonuses</div>
            <span class="bonus">‚Ä¢ ‚àí30% Honor Losses</span><br>
            <span class="bonus">‚Ä¢ Converts Specialists to Elites on Traditional Marches</span><br>
            <span class="bonus">‚Ä¢ +2 Offensive Specialist Strength (Affects NW)</span><br>
            <span class="bonus">‚Ä¢ +50% Honor Effects</span>
        `;
        persUnique = "(Passive) - All successful attacks generate 2.5% additional honour gains.";
    }
	
    document.getElementById('persBonusBox').innerHTML = persHtml;
    document.getElementById('persUniqueText').innerHTML = persUnique;

    // Show personality unique only if it exists
    document.getElementById('persUniqueLine').style.display = persUnique ? "block" : "none";

    updateMilitaryTable();
}

function updateMilitaryTable() {
    const race = document.getElementById('race').value;
    const table = document.getElementById('militaryTable');
    table.innerHTML = '';

    const units = {
    Avian:     { off: "Griffin 13/0",      	def: "Harpies 0/9",    elite: "Drakes 16/6",          specCost: 350, eliteCost: 900, thiefCost: 500 },
    "Dark Elf":{ off: "Night Rangers 15/0", def: "Druids 0/8",   	elite: "Drows 4/12",  		  specCost: 350, eliteCost: 900, thiefCost: 500 },
    Dwarf:     { off: "Warriors 10/0", 		def: "Axemen 0/11",     elite: "Berserkers 15/9",     specCost: 350, eliteCost: 900, thiefCost: 500 },
    Elf:       { off: "Rangers 10/0",       def: "Archers 0/13",    elite: "Elf Lords 14/6",      specCost: 350, eliteCost: 800, thiefCost: 500 },
    Faery:     { off: "Magicians 10/0",     def: "Druids 0/10",     elite: "Beastmasters 8/15",   specCost: 350, eliteCost: 900, thiefCost: 500 },
    Halfling:  { off: "Strongarms 10/0",    def: "Slingers 0/11",   elite: "Brutes 10/13",        specCost: 350, eliteCost: 900, thiefCost: 500 },
    Human:     { off: "Swordsmen 12/0",     def: "Archers 0/10",    elite: "Knights 14/9",        specCost: 350, eliteCost:1000, thiefCost: 500 },
    Orc:       { off: "Goblins 13/0",  		def: "Trolls 0/10",     elite: "Ogres 20/1",          specCost: 350, eliteCost: 850, thiefCost: 500 },
    Undead:    { off: "Skeletons 11/0",     def: "Zombies 0/10",    elite: "Ghouls 16/7",         specCost: 350, eliteCost: 900, thiefCost: 500 },
    Gnome:     { off: "Quick Blades 11/0", 	def: "Pikemen 0/10",   	elite: "Golems 14/4",         specCost: 350, eliteCost: 900, thiefCost: 500 }
}[race];

    const addRow = (name, curId, trainId, cost) => {
    const row = document.createElement('tr');

    row.innerHTML = `
    <td style="width:190px; padding:3px 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#ccc;">${name}</td>
    <td style="width:110px; text-align:center; padding:3px;">
        <input type="number" id="${curId}" value="0" min="0"
               style="width:92px; padding:3px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
    </td>
    <td style="width:110px; text-align:center; padding:3px;">
        <input type="number" id="${trainId}" value="0" min="0"
               style="width:92px; padding:3px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; text-align:center;">
    </td>
    <td style="width:120px; text-align:right; padding:3px 14px; color:#FFFF61; font-weight:bold;">
        $${cost.toLocaleString()}
    </td>
    `;

    table.appendChild(row);

    // Restore saved values
    const savedData = JSON.parse(localStorage.getItem('utopiaPlanner') || '{}');
    const savedOwned = savedData[curId] || "0";
    const savedTrain = savedData[trainId] || "0";

    const ownedInput = row.querySelector(`#${curId}`);
    const trainInput = row.querySelector(`#${trainId}`);

    ownedInput.value = savedOwned;
    trainInput.value = savedTrain;

    // Listeners for all Owned and Training inputs
    ownedInput.addEventListener('input', function() {
        updateTargetRatios();

        // Trigger correct calculation based on which row
        if (curId === 'curThief') calculateThievesNeeded();
        if (curId === 'curOff') calculateOffNeeded();
        if (curId === 'curDef') calculateDefNeeded();
        if (curId === 'curElite') calculateEliteNeeded();
    });

    trainInput.addEventListener('input', function() {
        updateTargetRatios();

        if (trainId === 'trainThief') calculateThievesNeeded();
        if (trainId === 'trainOff') calculateOffNeeded();
        if (trainId === 'trainDef') calculateDefNeeded();
        if (trainId === 'trainElite') calculateEliteNeeded();
    });
};

    addRow(units.off,    'curOff',    'trainOff',    units.specCost);     // O-Specs
	addRow(units.def,    'curDef',    'trainDef',    units.specCost);     // D-Specs
	addRow(units.elite,  'curElite',  'trainElite',  units.eliteCost);    // Elites
	addRow("Thieves",    'curThief',  'trainThief',  units.thiefCost);    // Thieves
	
	calculateTotalArmy();
	
	// FIX: Update thief calculation when owned or training thieves change
    const curThiefInput = document.getElementById('curThief');
    const trainThiefInput = document.getElementById('trainThief');

    if (curThiefInput) {
        curThiefInput.removeEventListener('input', calculateThievesNeeded);
        curThiefInput.addEventListener('input', calculateThievesNeeded);
    }
    if (trainThiefInput) {
        trainThiefInput.removeEventListener('input', calculateThievesNeeded);
        trainThiefInput.addEventListener('input', calculateThievesNeeded);
    }
	// FULL FIX: Re-attach listeners for BOTH Owned and Training O/D-Specs
    const curOffInput = document.getElementById('curOff');
    const trainOffInput = document.getElementById('trainOff');
    const curDefInput = document.getElementById('curDef');
    const trainDefInput = document.getElementById('trainDef');

    // O-Specs (Owned + Training)
    if (curOffInput) {
        curOffInput.removeEventListener('input', calculateOffNeeded);
        curOffInput.addEventListener('input', calculateOffNeeded);
    }
    if (trainOffInput) {
        trainOffInput.removeEventListener('input', calculateOffNeeded);
        trainOffInput.addEventListener('input', calculateOffNeeded);
    }

    // D-Specs (Owned + Training)
    if (curDefInput) {
        curDefInput.removeEventListener('input', calculateDefNeeded);
        curDefInput.addEventListener('input', calculateDefNeeded);
    }
    if (trainDefInput) {
        trainDefInput.removeEventListener('input', calculateDefNeeded);
        trainDefInput.addEventListener('input', calculateDefNeeded);
    }
	// Elite - Owned & Training listeners (robust version)
	const curEliteVisible = document.querySelector('#militaryTable input#curElite');
	const trainEliteVisible = document.querySelector('#militaryTable input#trainElite');

	// Owned Elite - make sure visible ‚Üí hidden sync + recalc
	if (curEliteVisible) {
		curEliteVisible.removeEventListener('input', handleCurEliteInput);
		curEliteVisible.addEventListener('input', handleCurEliteInput);
	}

	function handleCurEliteInput() {
		updateTargetRatios();
		calculateEliteNeeded();
	}

	// Training Elite - just recalc
	if (trainEliteVisible) {
		trainEliteVisible.removeEventListener('input', calculateEliteNeeded);
		trainEliteVisible.addEventListener('input', () => {
			updateTargetRatios();
			calculateEliteNeeded();
		});
	}
	
	// Re-attach SAVE listener to ALL military table inputs EVERY time table rebuilds
	document.querySelectorAll('#militaryTable input[type="number"]').forEach(input => {
		// Remove any old listener to avoid duplicates
		input.removeEventListener('input', saveMilitaryInputs);
		input.addEventListener('input', saveMilitaryInputs);
	});
}
function saveMilitaryInputs() {
		console.log('Saving military input:', this.id, '‚Üí', this.value); // Temporary debug - remove after testing
		const data = JSON.parse(localStorage.getItem('utopiaPlanner') || '{}');

		// Save this changed input (curOff, trainElite, etc.)
		data[this.id] = this.value || "0";

		// Keep main settings up-to-date too
		data.race  = document.getElementById('race').value;
		data.pers  = document.getElementById('pers').value;
		data.title = document.getElementById('title').value;
		data.acres = document.getElementById('acres').value;
		data.ome   = document.getElementById('ome').value || "100";
		data.dme   = document.getElementById('dme').value || "100";
		data.targetOSPA = document.getElementById('targetOSPA').value || "8.5";
		data.targetDSPA = document.getElementById('targetDSPA').value || "7.0";
		data.targetElite = document.getElementById('targetElite').value || "1.1";
		data.targetTPA = document.getElementById('targetTPA').value || "1.2";

		localStorage.setItem('utopiaPlanner', JSON.stringify(data));
	}
function updateTrainingTable() {
    const race = document.getElementById('race').value;
    const table = document.getElementById('TrainingTable');
    if (!table) return;
    table.innerHTML = '';

    const units = {
    Avian:     { off: "Griffin 13/0",      	def: "Harpies 0/9",    elite: "Drakes 16/6",          specCost: 350, eliteCost: 900, thiefCost: 500 },
    "Dark Elf":{ off: "Night Rangers 15/0", def: "Druids 0/8",   	elite: "Drows 4/12",  		  specCost: 350, eliteCost: 900, thiefCost: 500 },
    Dwarf:     { off: "Warriors 10/0", 		def: "Axemen 0/11",     elite: "Berserkers 15/9",     specCost: 350, eliteCost: 900, thiefCost: 500 },
    Elf:       { off: "Rangers 10/0",       def: "Archers 0/13",    elite: "Elf Lords 14/6",      specCost: 350, eliteCost: 800, thiefCost: 500 },
    Faery:     { off: "Magicians 10/0",     def: "Druids 0/10",     elite: "Beastmasters 8/15",   specCost: 350, eliteCost: 900, thiefCost: 500 },
    Halfling:  { off: "Strongarms 10/0",    def: "Slingers 0/11",   elite: "Brutes 10/13",        specCost: 350, eliteCost: 900, thiefCost: 500 },
    Human:     { off: "Swordsmen 12/0",     def: "Archers 0/10",    elite: "Knights 14/9",        specCost: 350, eliteCost:1000, thiefCost: 500 },
    Orc:       { off: "Goblins 13/0",  		def: "Trolls 0/10",     elite: "Ogres 20/1",          specCost: 350, eliteCost: 850, thiefCost: 500 },
    Undead:    { off: "Skeletons 11/0",     def: "Zombies 0/10",    elite: "Ghouls 16/7",         specCost: 350, eliteCost: 900, thiefCost: 500 },
    Gnome:     { off: "Quick Blades 11/0", 	def: "Pikemen 0/10",   	elite: "Golems 14/4",         specCost: 350, eliteCost: 900, thiefCost: 500 }
}[race];

    const addRow = (label, isOffRow = false, isDefRow = false, isThiefRow = false, isEliteRow = false, isTotalRow = false) => {
        const row = document.createElement('tr');
        let toTrainCell = '‚Äî';
        let costCell = '‚Äî';

        if (isTotalRow) {
            // Soldiers Needed & Total Cost row
            toTrainCell = '<span id="calcSoldiersNeeded">0</span>';
            costCell = '<span id="totalTrainingCost">$0</span>';
        } else if (isOffRow || isDefRow || isThiefRow || isEliteRow) {
            toTrainCell = '<span id="' + (isOffRow ? 'calcOff' : 
                                         isDefRow ? 'calcDef' : 
                                         isThiefRow ? 'calcThieves' : 
                                         'calcElite') + '">0</span>';
            costCell = '<span id="' + (isOffRow ? 'offCost' : 
                                       isDefRow ? 'defCost' : 
                                       isThiefRow ? 'thiefCost' : 
                                       'eliteCost') + '">$0</span>';
        }

        row.innerHTML = `
            <td style="width:190px; padding:3px 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${label}
            </td>
            <td style="width:130px; text-align:center; padding:3px; font-weight:bold;">
                ${toTrainCell}
            </td>
            <td style="width:130px; text-align:center; padding:3px; font-weight:bold; color:#FFFF61;">
                ${costCell}
            </td>
        `;
        table.appendChild(row);
    };

    // Add regular rows
    addRow(units.off, true);          // O-Specs
    addRow(units.def, false, true);   // D-Specs
    addRow(units.elite, false, false, false, true);  // Elites
    addRow("Thieves", false, false, true);           // Thieves

    // Spacer row (visual separation)
    const spacer = document.createElement('tr');
    spacer.innerHTML = '<td colspan="3" style="height:12px; background:transparent;"></td>';
    table.appendChild(spacer);

    // Add total row
    addRow("Soldiers Needed", false, false, false, false, true);

    // Recalculate everything (this will update spans)
    calculateOffNeeded();
    calculateDefNeeded();
    calculateEliteNeeded();
    calculateThievesNeeded();

    // NEW: Calculate total soldiers needed and total cost
    calculateTotalTraining();
}

// THIEVES CALC FORMULA
function calculateThievesNeeded() {
    const acres = parseFloat(document.getElementById('acres').value) || 0;
    const targetTPA = parseFloat(document.getElementById('targetTPA').value) || 0;

    const ownedThieves = parseInt(document.querySelector('#curThief')?.value || 0);
    const trainingThieves = parseInt(document.querySelector('#trainThief')?.value || 0);

    const totalNeeded = Math.round(acres * targetTPA);
    const currentTotal = ownedThieves + trainingThieves;
    const toTrain = totalNeeded - currentTotal;  // Allows negative

    // Get thief cost from the units object (same as military table)
    const race = document.getElementById('race').value;
    const units = {
        Avian:     { thiefCost: 500 },
        "Dark Elf":{ thiefCost: 600 },
        Dwarf:     { thiefCost: 500 },
        Elf:       { thiefCost: 500 },
        Faery:     { thiefCost: 500 },
        Halfling:  { thiefCost: 500 },
        Human:     { thiefCost: 500 },
        Orc:       { thiefCost: 500 },
        Undead:    { thiefCost: 500 },
        Gnome:     { thiefCost: 500 }
    }[race];

    const thiefCost = units?.thiefCost || 500;
    const totalCost = Math.max(0, toTrain) * thiefCost;  // Only cost for positive needed (0 if over)

    // Update "To be Trained"
    const trainCell = document.getElementById('calcThieves');
    if (trainCell) {
        trainCell.textContent = toTrain.toLocaleString();
        if (toTrain > 0) trainCell.style.color = '#4ade80';
        else if (toTrain < 0) trainCell.style.color = '#ff6b6b';
        else trainCell.style.color = '#ccc';
    }

    // Update "Cost"
    const costCell = document.getElementById('thiefCost');
    if (costCell) {
        costCell.textContent = '$' + totalCost.toLocaleString();
    }
	
	calculateTotalTraining();
}

// DSPECS CALC FORMULA
function calculateDefNeeded() {
    const acres = parseFloat(document.getElementById('acres').value) || 0;
    const targetDSPA = parseFloat(document.getElementById('targetDSPA').value) || 0;
    const dme = parseFloat(document.getElementById('dme').value) || 100;

    const ownedDef = parseInt(document.querySelector('#curDef')?.value || 0);
    const trainingDef = parseInt(document.querySelector('#trainDef')?.value || 0);

    // Race-specific D-Spec defense value (points per spec)
    const race = document.getElementById('race').value;
    const defValue = {
        Avian: 10, "Dark Elf": 11, Dwarf: 10, Elf: 12, Faery: 10,
        Halfling: 10, Human: 10, Orc: 10, Undead: 10, Gnome: 10
    }[race] || 10;

    // Step 1: Total defense points needed per acre √ó base (10)
    const pointsPerAcre = acres * targetDSPA;
    const totalDefPointsTarget = pointsPerAcre * 10;  // Always √ó10 (your Excel method)

    // Step 2: Adjust for DME (divide by multiplier)
    const adjustedPointsNeeded = totalDefPointsTarget / (dme / 100);

    // Step 3: Total D-Specs needed (divide by race-specific value)
    const totalSpecsNeeded = Math.round(adjustedPointsNeeded / defValue);

    // Step 4: To train (allows negative)
    const currentTotal = ownedDef + trainingDef;
    const toTrain = totalSpecsNeeded - currentTotal;

    // Cost (350gc per spec, only for positive needed)
    const totalCost = Math.max(0, toTrain) * 350;

    // Update "To be Trained"
    const trainCell = document.getElementById('calcDef');
    if (trainCell) {
        trainCell.textContent = toTrain.toLocaleString();
        trainCell.style.color = toTrain > 0 ? '#4ade80' : (toTrain < 0 ? '#ff6b6b' : '#ccc');
    }

    // Update "Cost"
    const costCell = document.getElementById('defCost');
    if (costCell) {
        costCell.textContent = '$' + totalCost.toLocaleString();
    }
	
	calculateTotalTraining();
}

// OSPECS CALC FORMULA
function calculateOffNeeded() {
    const acres = parseFloat(document.getElementById('acres').value) || 0;
    const targetOSPA = parseFloat(document.getElementById('targetOSPA').value) || 0;
    const ome = parseFloat(document.getElementById('ome').value) || 100;

    const ownedOff = parseInt(document.querySelector('#curOff')?.value || 0);
    const trainingOff = parseInt(document.querySelector('#trainOff')?.value || 0);

    // Race-specific O-Spec offense value (parse from string, e.g., "Griffins 12/0" ‚Üí 12)
    const race = document.getElementById('race').value;
    const offString = {
        Avian: "Griffins 12/0",
        "Dark Elf": "Night Rangers 10/0",
        Dwarf: "Warriors 10/0",
        Elf: "Rangers 10/0",
        Faery: "Magicians 10/0",
        Halfling: "Strongarms 10/0",
        Human: "Swordsmen 13/0",
        Orc: "Goblins 10/0",
        Undead: "Skeletons 10/0",
        Gnome: "Quick Blades 11/0"
    }[race] || "10/0";
    const offValue = parseInt(offString.match(/(\d+)\/0/)?.[1]) || 10;

    // Step 1: Total offense points needed per acre √ó base (10)
    const pointsPerAcre = acres * targetOSPA;
    const totalOffPointsTarget = pointsPerAcre * 10;  // Always √ó10

    // Step 2: Adjust for OME (divide by multiplier)
    const adjustedPointsNeeded = totalOffPointsTarget / (ome / 100);

    // Step 3: Total O-Specs needed (divide by race-specific value)
    const totalSpecsNeeded = Math.round(adjustedPointsNeeded / offValue);

    // Step 4: To train (allows negative)
    const currentTotal = ownedOff + trainingOff;
    const toTrain = totalSpecsNeeded - currentTotal;

    // Cost (350gc per spec, only for positive needed)
    const totalCost = Math.max(0, toTrain) * 350;

    // Update "To be Trained"
    const trainCell = document.getElementById('calcOff');
    if (trainCell) {
        trainCell.textContent = toTrain.toLocaleString();
        trainCell.style.color = toTrain > 0 ? '#4ade80' : (toTrain < 0 ? '#ff6b6b' : '#ccc');
    }

    // Update "Cost"
    const costCell = document.getElementById('offCost');
    if (costCell) {
        costCell.textContent = '$' + totalCost.toLocaleString();
    }
	
	calculateTotalTraining();
}

// ESPA CALC FORMULA
function calculateEliteNeeded() {
    const acres = parseFloat(document.getElementById('acres').value) || 0;
    const targetElite = parseFloat(document.getElementById('targetElite').value) || 0;

    const ownedElite = parseInt(document.querySelector('#curElite')?.value || 0);
    const trainingElite = parseInt(document.querySelector('#trainElite')?.value || 0);

    // Total Elites needed
    const totalNeeded = Math.round(acres * targetElite);
    const currentTotal = ownedElite + trainingElite;
    const toTrain = totalNeeded - currentTotal;  // can be negative

    // Get race-specific elite cost
    const race = document.getElementById('race').value;
    const units = {
        Avian:     { eliteCost: 900 },
        "Dark Elf":{ eliteCost: 900 },
        Dwarf:     { eliteCost: 1000 },
        Elf:       { eliteCost: 1000 },
        Faery:     { eliteCost: 1200 },
        Halfling:  { eliteCost: 850 },
        Human:     { eliteCost: 1050 },
        Orc:       { eliteCost: 1200 },
        Undead:    { eliteCost: 900 },
        Gnome:     { eliteCost: 900 }
    }[race] || { eliteCost: 900 };  // fallback

    const eliteCostPerUnit = units.eliteCost;
    const totalCost = Math.max(0, toTrain) * eliteCostPerUnit;

    // Update "To be Trained"
    const trainCell = document.getElementById('calcElite');
    if (trainCell) {
        trainCell.textContent = toTrain.toLocaleString();
        trainCell.style.color = toTrain > 0 ? '#4ade80' : (toTrain < 0 ? '#ff6b6b' : '#ccc');
    }

    // Update "Cost"
    const costCell = document.getElementById('eliteCost');
    if (costCell) {
        costCell.textContent = '$' + totalCost.toLocaleString();
    }

    calculateTotalTraining();
}

// Update on any change
['acres', 'targetTPA', 'curThief', 'trainThief'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', calculateThievesNeeded);
});

// Update D-Specs on any relevant change
['acres', 'targetDSPA', 'dme', 'curDef', 'trainDef'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', calculateDefNeeded);
});
document.getElementById('race')?.addEventListener('change', calculateDefNeeded);  // For race-specific def value

// Update O-Specs on any relevant change
['acres', 'targetOSPA', 'ome', 'curOff', 'trainOff'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', calculateOffNeeded);
});
document.getElementById('race')?.addEventListener('change', calculateOffNeeded);

// Update Elites on relevant changes
['acres', 'targetElite', 'curElite', 'trainElite'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', calculateEliteNeeded);
});
document.getElementById('race')?.addEventListener('change', calculateEliteNeeded);

function openParser() {
    window.open('Parser v1.4.3.html', '_blank');
}

function openSciences() {
    window.open('Sciences v1.0.4.html', '_blank');
}

function goToPage(page) {
    window.location.href = page;  // Replaces current page - no new tab
}

// Auto-update Target Ratios table
function updateTargetRatios() {
    const acres = parseFloat(document.getElementById('acres').value) || 1;

    // READ DIRECTLY FROM THE VISIBLE INPUTS ‚Äî never trust the hidden ones
    const ownedOff    = parseInt(document.querySelector('#curOff')?.value || 0);
    const trainOff    = parseInt(document.querySelector('#trainOff')?.value || 0);
    const ownedDef    = parseInt(document.querySelector('#curDef')?.value || 0);
    const trainDef    = parseInt(document.querySelector('#trainDef')?.value || 0);
    const ownedElite  = parseInt(document.querySelector('#curElite')?.value || 0);
    const trainElite  = parseInt(document.querySelector('#trainElite')?.value || 0);
    const ownedThief  = parseInt(document.querySelector('#curThief')?.value || 0);
    const trainThief  = parseInt(document.querySelector('#trainThief')?.value || 0);

    const currentOSPA   = ((ownedOff   + trainOff)   / acres).toFixed(2);
    const currentDSPA   = ((ownedDef   + trainDef)   / acres).toFixed(2);
    const currentElite  = ((ownedElite + trainElite) / acres).toFixed(2);
    const currentTPA    = ((ownedThief + trainThief) / acres).toFixed(2);

    const targetOSPA = parseFloat(document.getElementById('targetOSPA').value) || 0;
    const targetDSPA = parseFloat(document.getElementById('targetDSPA').value) || 0;
    const targetElite = parseFloat(document.getElementById('targetElite').value) || 0;
    const targetTPA = parseFloat(document.getElementById('targetTPA').value) || 0;

    // Show only the current value
    document.getElementById('resultOSPA').textContent = currentOSPA;
    document.getElementById('resultDSPA').textContent = currentDSPA;
    document.getElementById('resultElite').textContent = currentElite;
    document.getElementById('resultTPA').textContent   = currentTPA;

    // Green if met or exceeded
    document.getElementById('resultOSPA').style.color = currentOSPA >= targetOSPA ? '#4ade80' : '#ff6b6b';
    document.getElementById('resultDSPA').style.color = currentDSPA >= targetDSPA ? '#4ade80' : '#ff6b6b';
    document.getElementById('resultElite').style.color = currentElite >= targetElite ? '#4ade80' : '#ff6b6b';
    document.getElementById('resultTPA').style.color   = currentTPA   >= targetTPA   ? '#4ade80' : '#ff6b6b';
}

/* Initial call */
updateTargetRatios();
calculateThievesNeeded();

// DARK / LIGHT MODE TOGGLE
const toggleButton = document.getElementById('themeToggle');
const body = document.body;

// Load saved theme preference
const savedTheme = localStorage.getItem('utopiaTheme');
if (savedTheme === 'light') {
    body.classList.add('light-mode');
    toggleButton.textContent = 'üåô Dark Mode';
} else {
    toggleButton.textContent = '‚òÄÔ∏è Light Mode';
}

// Toggle on click
toggleButton.addEventListener('click', () => {
    body.classList.toggle('light-mode');

    if (body.classList.contains('light-mode')) {
        toggleButton.textContent = 'üåô Dark Mode';
        localStorage.setItem('utopiaTheme', 'light');
    } else {
        toggleButton.textContent = '‚òÄÔ∏è Light Mode';
        localStorage.setItem('utopiaTheme', 'dark');
    }
});

function calculateTotalTraining() {
    // Helper to safely parse formatted numbers like "4,053" or "-339" or "0"
    const parseFormatted = (text) => {
        if (!text) return 0;
        // Remove $ , and other non-digits except minus sign
        const cleaned = text.replace(/[^0-9-]/g, '');
        return parseInt(cleaned, 10) || 0;
    };

    // Get all "To be Trained" values (as displayed, with commas)
    const offTrain    = parseFormatted(document.getElementById('calcOff')?.textContent || '0');
    const defTrain    = parseFormatted(document.getElementById('calcDef')?.textContent || '0');
    const eliteTrain  = parseFormatted(document.getElementById('calcElite')?.textContent || '0');
    const thiefTrain  = parseFormatted(document.getElementById('calcThieves')?.textContent || '0');

    // Sum only positive values (ignore negative/over-trained)
    const totalSoldiers = Math.max(0, offTrain) + Math.max(0, defTrain) + 
                          Math.max(0, eliteTrain) + Math.max(0, thiefTrain);

    // Update Soldiers Needed display
    const soldiersCell = document.getElementById('calcSoldiersNeeded');
    if (soldiersCell) {
        soldiersCell.textContent = totalSoldiers.toLocaleString();
        soldiersCell.style.color = totalSoldiers > 0 ? '#4ade80' : '#ccc';
    }

    // Get all training costs (remove $ and commas)
    const parseCost = (text) => {
        if (!text) return 0;
        const cleaned = text.replace(/[$,]/g, '');
        return parseFloat(cleaned) || 0;
    };

    const offCost    = parseCost(document.getElementById('offCost')?.textContent || '0');
    const defCost    = parseCost(document.getElementById('defCost')?.textContent || '0');
    const eliteCost  = parseCost(document.getElementById('eliteCost')?.textContent || '0');
    const thiefCost  = parseCost(document.getElementById('thiefCost')?.textContent || '0');

    const totalCost = offCost + defCost + eliteCost + thiefCost;

    // Update Total Cost display
    const totalCostCell = document.getElementById('totalTrainingCost');
    if (totalCostCell) {
        totalCostCell.textContent = '$' + Math.round(totalCost).toLocaleString();
        totalCostCell.style.color = totalCost > 0 ? '#FFFF61' : '#ccc';
    }
}

// NEW: Draft Date Calculator
function calculateDates() {
    const yearStr = document.getElementById('utopiaYear')?.value || 'YR8';
    const month = parseInt(document.getElementById('utopiaMonth')?.value || 6); // June = 6
    const day = parseInt(document.getElementById('utopiaDay')?.value || 22);

    const trainingDays = parseInt(document.getElementById('trainingPeriod')?.value || 0);
    const draftDays = parseInt(document.getElementById('draftPeriod')?.value || 0);

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July'];
    const startYear = parseInt(yearStr.replace('YR', '')) || 8;

    // Helper: Subtract days from a given year/month/day
    function subtractDays(baseYear, baseMonth, baseDay, daysToSubtract) {
        let totalDays = (baseMonth - 1) * 24 + baseDay;
        totalDays -= daysToSubtract;

        let newYear = baseYear;
        while (totalDays <= 0) {
            totalDays += 168; // 7 months √ó 24 days = 168 days per year
            newYear--;
        }

        let newMonth = Math.floor((totalDays - 1) / 24) + 1;
        let newDay = ((totalDays - 1) % 24) + 1;

        return { year: newYear, month: newMonth, day: newDay };
    }

    // 1. Train by Date = EOWCF - Training Period
    const trainDate = subtractDays(startYear, month, day, trainingDays);

    // 2. Draft by Date = Train by Date - Draft Period
    const draftDate = subtractDays(trainDate.year, trainDate.month, trainDate.day, draftDays);

    const getMonthName = (m) => monthNames[m - 1] || 'January';

    // Display results (backward)
    document.getElementById('trainByDate').textContent = 
        `YR${trainDate.year} ${getMonthName(trainDate.month)} ${trainDate.day}`;

    document.getElementById('draftByDate').textContent = 
        `YR${draftDate.year} ${getMonthName(draftDate.month)} ${draftDate.day}`;
}

// Update dates when Utopia calendar changes
['utopiaYear', 'utopiaMonth', 'utopiaDay', 'draftPeriod', 'trainingPeriod'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', calculateDates);
});

// Initial calculation
calculateDates();

// Populate Utopia Day dropdown (1-24)
function populateUtopiaDays() {
    const daySelect = document.getElementById('utopiaDay');
    if (!daySelect) return;

    daySelect.innerHTML = '';
    for (let day = 1; day <= 24; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day;
        daySelect.appendChild(option);
    }

    // Default to day 1
    daySelect.value = 1;
}

// Combine Utopia date into a string for display/debug (optional)
function getUtopiaDateString() {
    const year = document.getElementById('utopiaYear')?.value || 'YR3';
    const month = document.getElementById('utopiaMonth')?.value || '1';
    const day = document.getElementById('utopiaDay')?.value || '1';
    return `${year} ${getMonthName(month)} ${day}`;
}

function getMonthName(monthNum) {
    const names = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July'];
    return names[parseInt(monthNum)] || 'January';
}

// Run on load
populateUtopiaDays();

// Auto-update when any input changes
['endCFDate', 'draftPeriod', 'trainingPeriod'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', calculateDates);
});

// Calculate total army: sum of all 8 inputs from Military table (Owned + Training)
function calculateTotalArmy() {
    const ids = [
        'curOff', 'trainOff',
        'curDef', 'trainDef',
        'curElite', 'trainElite',
        'curThief', 'trainThief'
    ];

    let total = 0;

    ids.forEach(id => {
        const input = document.getElementById(id);
        if (input && !isNaN(input.value)) {
            total += parseInt(input.value, 10) || 0;
        }
    });

    const totalArmyCell = document.getElementById('totalArmy');
    if (totalArmyCell) {
        totalArmyCell.textContent = total.toLocaleString();
        totalArmyCell.style.color = total > 0 ? '#4ade80' : '#ccc';
    }
}

// Auto-update total army on any military input change (using event delegation)
document.addEventListener('input', function(e) {
    if (e.target.matches('#militaryTable input[type="number"]')) {
        calculateTotalArmy();
    }
});

// Run total army calculation after military table is built/updated
// Add this line inside updateMilitaryTable(), right after the last addRow() and before the listeners:
calculateTotalArmy();  // ‚Üê Add this line here!

// Also run on initial page load (after all tables are built)
window.addEventListener('load', () => {
    setTimeout(calculateTotalArmy, 500); // Small delay to ensure DOM is ready
});

// When user returns to this tab, force recalc (handles tab-switch timing issues)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        updateHousingScienceDisplay();
        calculateTotalPopulation();
    }
});

// Update the Housing Science display
function updateHousingScienceDisplay() {
    const savedValue = localStorage.getItem('utopiaHousingOutputPercent');
    const displayEl = document.getElementById('displayHousingScience');
    
    if (displayEl) {
        if (savedValue !== null && savedValue !== '' && savedValue !== '0.00') {
            displayEl.textContent = savedValue + '%';
            displayEl.style.color = '#4ade80'; // green
        } else {
            displayEl.textContent = '‚Äî%';
            displayEl.style.color = '#888';
        }
    }
    
    // IMPORTANT: Recalculate modified population whenever housing science updates
    calculateTotalPopulation();
}

// Modified Living Space = Raw √ó Race Bonus √ó Housing Science √ó Honor Bonus
function calculateTotalPopulation() {
    // Get Acres
    const acresInput = document.getElementById('acres');
    if (!acresInput) return;
    const acres = parseFloat(acresInput.value) || 0;

    // Get Homes %
    const homesInput = document.getElementById('homesPercent');
    const homesPercent = parseFloat(homesInput?.value) || 0;

    // Get Race (for race pop bonus)
    const race = document.getElementById('race')?.value || 'Human';

    // Get Honor Title
    const title = document.getElementById('title')?.value || 'Peasant';

    // Get displayed Housing Science % directly from the planner (e.g. "15%" ‚Üí 15)
    const housingDisplay = document.getElementById('displayHousingScience')?.textContent || '‚Äî%';
    let housingSciencePercent = 0;
    if (housingDisplay !== '‚Äî%') {
        housingSciencePercent = parseFloat(housingDisplay.replace('%', '')) || 0;
    }

    // 1. Raw Living Space
    const basePeasants = Math.round(acres * 25);
    const homesAcres = acres * (homesPercent / 100);
    const popFromHomes = Math.round(homesAcres * 10);
    const rawLivingSpace = basePeasants + popFromHomes;

    // 2. Race Population Bonus (multiplier)
    let raceBonus = 1.0;
    if (race === 'Halfling') raceBonus = 1.15;

    // 3. Housing Science Bonus (from displayed value)
    const housingMultiplier = 1 + (housingSciencePercent / 100);

    // 4. Honor Title Population Bonus (corrected standard values)
    let honorBonus = 1.0;
    switch (title) {
        case 'Peasant':              honorBonus = 1.00; break;
        case 'Knight/Lady':          honorBonus = 1.01; break;
        case 'Lord/Noble Lady':      honorBonus = 1.02; break;
        case 'Baron/Baroness':       honorBonus = 1.03; break;
        case 'Viscount/Viscountess': honorBonus = 1.04; break;
        case 'Count/Countess':       honorBonus = 1.06; break;
        case 'Marquis/Marchioness':  honorBonus = 1.08; break;
        case 'Duke/Duchess':         honorBonus = 1.10; break;
        case 'Prince/Princess':      honorBonus = 1.12; break;
        default:                     honorBonus = 1.00;
    }

    // 5. Final Modified Living Space (round to nearest whole number)
    const modifiedPop = Math.round(rawLivingSpace * raceBonus * housingMultiplier * honorBonus);

    // Update display
    const popCell = document.getElementById('totalPopulation');
    if (popCell) {
        popCell.textContent = modifiedPop.toLocaleString();
        popCell.style.color = modifiedPop > 0 ? '#4ade80' : '#ccc';
    }
}

// Load on page open
updateHousingScienceDisplay();

// Listen for live updates from Sciences page (when it changes localStorage)
window.addEventListener('storage', (event) => {
    if (event.key === 'utopiaHousingOutputPercent') {
        updateHousingScienceDisplay();
    }
});

// Optional: Re-check every 5 seconds (in case storage event is missed in some browsers)
setInterval(() => {
    updateHousingScienceDisplay();     // updates the % display if needed
    calculateTotalPopulation();        // forces population to use the latest displayed %
}, 5000);

// Update population when Acres, Homes %, Race, or Title changes
['acres', 'homesPercent', 'race', 'title'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', calculateTotalPopulation);
        el.addEventListener('change', calculateTotalPopulation);
    }
});

// Extra safety call after full load
window.addEventListener('load', () => {
    setTimeout(calculateTotalPopulation, 300);
});

</script>

</body>
</html>